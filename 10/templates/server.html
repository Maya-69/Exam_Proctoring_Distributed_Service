<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .cluster-visual {
            display: flex;
            gap: 2rem;
            margin-top: 1.5rem;
            justify-content: space-around;
        }
        .cluster-node {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            min-width: 180px;
            transition: all 0.3s;
            position: relative;
        }
        .cluster-node:hover {
            transform: scale(1.05);
        }
        .cluster-node.overloaded {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .node-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        .node-value {
            font-size: 2rem;
            font-weight: 700;
        }
        .node-capacity {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        .network-gauge {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .gauge-bar {
            flex: 1;
            height: 30px;
            background: #e0e6ed;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        .gauge-fill {
            height: 100%;
            border-radius: 15px;
            transition: all 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .gauge-fill.healthy {
            background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
        }
        .gauge-fill.warning {
            background: linear-gradient(90deg, #f2994a 0%, #f2c94c 100%);
        }
        .gauge-fill.critical {
            background: linear-gradient(90deg, #eb3349 0%, #f45c43 100%);
        }
        .http-log {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #6c757d;
            padding: 0.4rem 0.6rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 0.3rem;
        }
        .http-log .method {
            color: #3498db;
            font-weight: 600;
        }
        .http-log .status-200 {
            color: #27ae60;
            font-weight: 600;
        }
        .http-log .path {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üñ•Ô∏è Server Dashboard - Real-time Monitoring</h1>
        <button onclick="logout()" class="btn-logout">Logout</button>
    </nav>
    
    <div class="container">
        <!-- Cluster Visualization -->
        <div class="section">
            <h2>Server Cluster Status</h2>
            <div class="cluster-visual">
                <div class="cluster-node" id="mainServerNode">
                    <div class="node-title">MAIN SERVER</div>
                    <div class="node-value" id="mainServerCount">0</div>
                    <div class="node-capacity">Capacity: <span id="mainCapacity">0/8</span></div>
                </div>
                <div class="cluster-node" id="backupServerNode">
                    <div class="node-title">BACKUP SERVER</div>
                    <div class="node-value" id="backupServerCount">0</div>
                    <div class="node-capacity">Capacity: <span id="backupCapacity">0/8</span></div>
                </div>
            </div>
        </div>

        <!-- Network Health -->
        <div class="section">
            <h2>Network Health Monitoring</h2>
            <div class="network-gauge">
                <strong style="min-width: 100px;">Latency:</strong>
                <div class="gauge-bar">
                    <div class="gauge-fill healthy" id="latencyBar" style="width: 0%">
                        <span id="latencyValue">0 ms</span>
                    </div>
                </div>
            </div>
            <div class="network-gauge">
                <strong style="min-width: 100px;">Packet Loss:</strong>
                <div class="gauge-bar">
                    <div class="gauge-fill healthy" id="packetLossBar" style="width: 0%">
                        <span id="packetLossValue">0%</span>
                    </div>
                </div>
            </div>
            <div class="network-gauge">
                <strong style="min-width: 100px;">Status:</strong>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="status-indicator status-active"></span>
                    <span id="networkStatus" style="font-weight: 600; color: #27ae60;">HEALTHY</span>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Requests</h3>
                <p class="stat-value" id="totalRequests">0</p>
            </div>
            <div class="stat-card">
                <h3>Active Exams</h3>
                <p class="stat-value" id="activeExams">0</p>
            </div>
            <div class="stat-card">
                <h3>Submissions</h3>
                <p class="stat-value" id="totalSubmissions">0</p>
            </div>
            <div class="stat-card">
                <h3>Avg Score</h3>
                <p class="stat-value" id="avgScore">0%</p>
            </div>
        </div>
        
        <!-- Active Students -->
        <div class="section">
            <h2>Active Exam Sessions</h2>
            <div id="activeStudents" style="padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                <p>No students taking exams currently</p>
            </div>
        </div>
        
        <!-- Database Replication -->
        <div class="section">
            <h2>Database Replication (RF=3)</h2>
            <div id="replicaStatus" class="replica-grid"></div>
        </div>
        
        <!-- Real-time Server Logs -->
        <div class="section">
            <h2>Server Logs (Real-time)</h2>
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
                <button onclick="clearLogs()" class="btn-secondary" style="margin: 0;">Clear Logs</button>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="autoScroll" checked>
                    <span>Auto-scroll</span>
                </label>
            </div>
            <div class="log-container" id="serverLogs">
                <div class="log-entry log-info">
                    <span class="log-time">Loading...</span>
                    <span class="log-message">Initializing logs...</span>
                </div>
            </div>
        </div>

        <!-- HTTP Request Logs -->
        <div class="section">
            <h2>HTTP Requests (Last 20)</h2>
            <div id="httpLogs" style="max-height: 300px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                <p style="color: #95a5a6;">Waiting for HTTP requests...</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io('/server');
        const httpLogs = [];
        const maxHttpLogs = 20;
        
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server dashboard');
        });
        
        socket.on('server_log', (log) => {
            addLogEntry(log);
        });

        socket.on('http_request', (request) => {
            addHttpLog(request);
        });
        
        function addLogEntry(log) {
            const logsContainer = document.getElementById('serverLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${log.type.toLowerCase()}`;
            logEntry.innerHTML = `
                <span class="log-time">${log.timestamp}</span>
                <span class="log-message">${log.message}</span>
            `;
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            
            if (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.lastChild);
            }

            if (document.getElementById('autoScroll').checked) {
                logsContainer.scrollTop = 0;
            }
        }

        function addHttpLog(request) {
            httpLogs.unshift(request);
            if (httpLogs.length > maxHttpLogs) {
                httpLogs.pop();
            }
            updateHttpLogs();
        }

        function updateHttpLogs() {
            const container = document.getElementById('httpLogs');
            if (httpLogs.length === 0) {
                container.innerHTML = '<p style="color: #95a5a6;">Waiting for HTTP requests...</p>';
                return;
            }

            container.innerHTML = httpLogs.map(req => `
                <div class="http-log">
                    <span class="log-time">${req.timestamp}</span>
                    <span class="method">${req.method}</span>
                    <span class="path">${req.path}</span>
                    <span class="status-${req.status}">${req.status}</span>
                </div>
            `).join('');
        }

        function clearLogs() {
            document.getElementById('serverLogs').innerHTML = '';
        }
        
        function updateStats() {
            fetch('/api/server/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalRequests').textContent = data.total_requests;
                    document.getElementById('activeExams').textContent = data.active_exams;
                    document.getElementById('totalSubmissions').textContent = data.total_submissions;
                    document.getElementById('avgScore').textContent = data.average_score.toFixed(1) + '%';
                    
                    const mainNode = document.getElementById('mainServerNode');
                    const backupNode = document.getElementById('backupServerNode');
                    
                    document.getElementById('mainServerCount').textContent = data.main_server_processed;
                    document.getElementById('backupServerCount').textContent = data.backup_server_processed;
                    document.getElementById('mainCapacity').textContent = `${Math.min(data.main_server_processed, 8)}/8`;
                    document.getElementById('backupCapacity').textContent = `${Math.min(data.backup_server_processed, 8)}/8`;
                    
                    if (data.main_server_processed >= 8) {
                        mainNode.classList.add('overloaded');
                    } else {
                        mainNode.classList.remove('overloaded');
                    }
                    
                    if (data.backup_server_processed >= 8) {
                        backupNode.classList.add('overloaded');
                    } else {
                        backupNode.classList.remove('overloaded');
                    }
                    
                    const activeStudentsDiv = document.getElementById('activeStudents');
                    if (data.active_exam_students && data.active_exam_students.length > 0) {
                        activeStudentsDiv.innerHTML = '<p><strong>üéì Students giving exams:</strong> ' + 
                            data.active_exam_students.map(id => `<span style="padding: 0.3rem 0.6rem; background: #d6eaf8; border-radius: 4px; margin: 0.2rem; display: inline-block;">Student ${id}</span>`).join('') + '</p>';
                    } else {
                        activeStudentsDiv.innerHTML = '<p>No students taking exams currently</p>';
                    }
                    
                    updateNetworkHealth(data.network_health);
                    updateReplicaStatus(data.replica_status);
                });
        }

        function updateNetworkHealth(health) {
            const latency = health.latency;
            const packetLoss = health.packet_loss;
            const status = health.status;

            const latencyPercent = Math.min((latency / 100) * 100, 100);
            const latencyBar = document.getElementById('latencyBar');
            latencyBar.style.width = latencyPercent + '%';
            latencyBar.className = 'gauge-fill ' + (latency < 30 ? 'healthy' : latency < 60 ? 'warning' : 'critical');
            document.getElementById('latencyValue').textContent = latency + ' ms';

            const packetLossPercent = Math.min((packetLoss / 10) * 100, 100);
            const packetLossBar = document.getElementById('packetLossBar');
            packetLossBar.style.width = packetLossPercent + '%';
            packetLossBar.className = 'gauge-fill ' + (packetLoss < 1 ? 'healthy' : packetLoss < 3 ? 'warning' : 'critical');
            document.getElementById('packetLossValue').textContent = packetLoss.toFixed(1) + '%';

            document.getElementById('networkStatus').textContent = status;
            document.getElementById('networkStatus').style.color = status === 'HEALTHY' ? '#27ae60' : '#e74c3c';
        }

        function updateReplicaStatus(replicas) {
            const replicaDiv = document.getElementById('replicaStatus');
            replicaDiv.innerHTML = '';
            replicas.forEach(replica => {
                const card = document.createElement('div');
                card.className = 'replica-card';
                card.innerHTML = `
                    <h3>üìÄ ${replica.id.toUpperCase().replace('_', ' ')}</h3>
                    <p><span class="status-indicator status-active"></span> ${replica.status}</p>
                    <p><strong>Sync:</strong> ${replica.sync_status}</p>
                    <p><strong>Last:</strong> ${replica.last_sync || 'Never'}</p>
                `;
                replicaDiv.appendChild(card);
            });
        }
        
        function logout() {
            fetch('/api/logout', {method: 'POST'})
                .then(() => window.location.href = '/');
        }
        
        updateStats();
        setInterval(updateStats, 2000);
    </script>
</body>
</html>
